apiVersion: v1
kind: ConfigMap
metadata:
  name: oauth2-proxy-config
  namespace: oauth2-proxy
data:
  oauth2-proxy.cfg: |
    # OAuth2 Proxy configuration — Keycloak OIDC provider
    provider = "keycloak-oidc"
    provider_display_name = "Keycloak"
    client_id = "oauth2-proxy"

    # OIDC discovery (auto-configures endpoints)
    oidc_issuer_url = "https://keycloak.example.com/realms/CHANGEME_KC_REALM"

    # Redirect URL — must match Keycloak client redirect URI
    redirect_url = "https://auth.example.com/oauth2/callback"

    # Cookie settings
    cookie_domains = [".example.com"]
    cookie_secure = true
    cookie_samesite = "lax"
    cookie_name = "_oauth2_proxy"

    # Allow rd= redirects to any subdomain
    whitelist_domains = [".example.com"]

    # Skip "Sign in with Keycloak" button — go directly to Keycloak
    skip_provider_button = true

    # Email domain: allow all (Keycloak manages access)
    email_domains = ["*"]

    # Pass auth info to upstream via headers (user/email/groups only, no tokens)
    set_xauthrequest = true
    set_authorization_header = false
    pass_access_token = false

    # Scopes
    scope = "openid profile email"

    # Audience — Keycloak sets aud=["account"] by default; accept it
    oidc_extra_audiences = ["account"]

    # PKCE (recommended by Keycloak)
    code_challenge_method = "S256"

    # Session — extend cookie lifetime and enable refresh
    cookie_expire = "168h"
    cookie_refresh = "60m"

    # Skip auth for the health check endpoint
    skip_auth_routes = ["/ping"]

    # Reverse proxy mode (ForwardAuth)
    reverse_proxy = true

    # TLS verification — trust our private Root CA
    provider_ca_files = ["/etc/ssl/certs/vault-root-ca.pem"]

    # Upstream (not used in ForwardAuth mode, but required)
    upstreams = ["static://202"]

    # Logging
    logging_filename = ""
    standard_logging = true
    request_logging = true
    auth_logging = true

    # HTTP listener
    http_address = "0.0.0.0:4180"
