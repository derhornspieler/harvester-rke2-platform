apiVersion: v1
kind: ConfigMap
metadata:
  name: oauth2-proxy-auth-redirect
  namespace: oauth2-proxy
data:
  default.conf: |
    server {
        listen 4181;

        location = /healthz {
            return 200 "ok";
        }

        location = /oauth2/auth {
            # Forward the auth check to oauth2-proxy
            proxy_pass http://127.0.0.1:4180/oauth2/auth;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
            proxy_set_header X-Forwarded-Host  $http_x_forwarded_host;
            proxy_set_header X-Forwarded-Uri   $http_x_forwarded_uri;

            # Intercept non-2xx responses from oauth2-proxy
            proxy_intercept_errors on;

            # Convert 401 â†’ 302 redirect to the sign-in page
            error_page 401 = @redirect_to_signin;
        }

        location @redirect_to_signin {
            # Build the original URL from Traefik's forwarded headers
            set $rd_url $http_x_forwarded_proto://$http_x_forwarded_host$http_x_forwarded_uri;
            return 302 https://auth.example.com/oauth2/start?rd=$rd_url;
        }
    }
