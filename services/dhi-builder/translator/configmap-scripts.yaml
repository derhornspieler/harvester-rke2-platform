apiVersion: v1
kind: ConfigMap
metadata:
  name: dhi-translator-scripts
  namespace: dhi-builder
  labels:
    app.kubernetes.io/name: dhi-builder
data:
  translate.sh: |
    #!/usr/bin/env sh
    # translate.sh â€” Convert DHI catalog YAML to Dockerfile
    # Usage: translate.sh <dhi-yaml-path> [output-dockerfile-path]
    #
    # Reads a DHI HardenedImage YAML spec and generates a security-hardened
    # Dockerfile. Requires yq v4+ to be available in the container.
    set -eu

    DHI_YAML="${1:?Usage: translate.sh <dhi-yaml-path> [output-path]}"
    OUTPUT="${2:-Dockerfile}"

    if [ ! -f "${DHI_YAML}" ]; then
      echo "ERROR: DHI YAML file not found: ${DHI_YAML}" >&2
      exit 1
    fi

    # --- Extract fields from DHI YAML ---
    BASE=$(yq '.spec.base // "alpine:3.20"' "${DHI_YAML}")
    USER_NAME=$(yq '.spec.user.name // "appuser"' "${DHI_YAML}")
    USER_UID=$(yq '.spec.user.uid // 1000' "${DHI_YAML}")
    USER_GID=$(yq '.spec.user.gid // 1000' "${DHI_YAML}")
    ENTRYPOINT=$(yq -o=json '.spec.entrypoint // []' "${DHI_YAML}")
    REMOVE_SHELLS=$(yq '.spec.hardening.removeShells // false' "${DHI_YAML}")
    READ_ONLY_ROOTFS=$(yq '.spec.hardening.readOnlyRootfs // false' "${DHI_YAML}")
    NO_NEW_PRIVILEGES=$(yq '.spec.hardening.noNewPrivileges // false' "${DHI_YAML}")

    # Extract packages as space-separated list
    PACKAGES=$(yq -o=tsv '.spec.packages // [] | .[]' "${DHI_YAML}" | tr '\n' ' ')

    # Extract exposed ports
    EXPOSE_PORTS=$(yq -o=tsv '.spec.expose // [] | .[]' "${DHI_YAML}" | tr '\n' ' ')

    # --- Detect package manager from base image ---
    detect_pkg_manager() {
      case "${BASE}" in
        alpine*|*alpine*)
          echo "apk"
          ;;
        ubuntu*|debian*|*debian*|*ubuntu*)
          echo "apt"
          ;;
        centos*|rocky*|rhel*|fedora*|*redhat*)
          echo "yum"
          ;;
        *)
          echo "apk"
          ;;
      esac
    }

    PKG_MGR=$(detect_pkg_manager)

    # --- Generate Dockerfile ---
    {
      echo "# Auto-generated by DHI Translator"
      echo "# Source: ${DHI_YAML}"
      echo "# Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
      echo ""
      echo "FROM ${BASE}"
      echo ""
      echo "LABEL org.opencontainers.image.source=\"dhi-builder\""
      echo "LABEL org.opencontainers.image.description=\"Hardened image built by DHI pipeline\""
      echo ""

      # Install packages
      if [ -n "${PACKAGES}" ]; then
        echo "# Install required packages"
        case "${PKG_MGR}" in
          apk)
            echo "RUN apk add --no-cache ${PACKAGES}"
            ;;
          apt)
            echo "RUN apt-get update && \\"
            echo "    apt-get install -y --no-install-recommends ${PACKAGES}&& \\"
            echo "    apt-get clean && \\"
            echo "    rm -rf /var/lib/apt/lists/*"
            ;;
          yum)
            echo "RUN yum install -y ${PACKAGES}&& \\"
            echo "    yum clean all && \\"
            echo "    rm -rf /var/cache/yum"
            ;;
        esac
        echo ""
      fi

      # Create non-root user
      echo "# Create non-root user"
      case "${PKG_MGR}" in
        apk)
          echo "RUN addgroup -g ${USER_GID} ${USER_NAME} && \\"
          echo "    adduser -u ${USER_UID} -G ${USER_NAME} -D -h /home/${USER_NAME} ${USER_NAME}"
          ;;
        apt|yum)
          echo "RUN groupadd -g ${USER_GID} ${USER_NAME} && \\"
          echo "    useradd -u ${USER_UID} -g ${USER_GID} -m -d /home/${USER_NAME} ${USER_NAME}"
          ;;
      esac
      echo ""

      # Security hardening
      echo "# Security hardening"
      if [ "${REMOVE_SHELLS}" = "true" ]; then
        echo "RUN rm -f /bin/sh /bin/bash /bin/ash /bin/dash 2>/dev/null; \\"
        echo "    rm -f /usr/bin/sh /usr/bin/bash 2>/dev/null; \\"
        echo "    ln -sf /bin/true /bin/sh || true"
      fi

      if [ "${READ_ONLY_ROOTFS}" = "true" ]; then
        echo "RUN chmod 555 / && \\"
        echo "    mkdir -p /tmp /var/tmp && \\"
        echo "    chmod 1777 /tmp /var/tmp"
      fi

      if [ "${NO_NEW_PRIVILEGES}" = "true" ]; then
        echo "# noNewPrivileges is enforced at container runtime (securityContext)"
        echo "# Removing setuid/setgid bits from all binaries"
        echo "RUN find / -perm /6000 -type f -exec chmod a-s {} + 2>/dev/null || true"
      fi
      echo ""

      # Expose ports
      if [ -n "${EXPOSE_PORTS}" ]; then
        for PORT in ${EXPOSE_PORTS}; do
          echo "EXPOSE ${PORT}"
        done
        echo ""
      fi

      # Set user
      echo "USER ${USER_NAME}"
      echo ""

      # Entrypoint
      if [ "${ENTRYPOINT}" != "[]" ]; then
        echo "ENTRYPOINT ${ENTRYPOINT}"
      fi
    } > "${OUTPUT}"

    echo "Dockerfile generated: ${OUTPUT}"
