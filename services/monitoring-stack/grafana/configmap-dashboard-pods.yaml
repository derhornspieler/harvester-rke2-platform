apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-pods
  namespace: monitoring
  labels:
    app: grafana
    grafana-dashboard: "true"
data:
  pod-monitoring.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "gnetId": 17391,
      "id": null,
      "links": [],
      "panels": [
        {
          "title": "CPU Usage by Pod",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
          "id": 1,
          "fieldConfig": {"defaults": {"unit": "short", "custom": {"drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "stacking": {"mode": "none"}}}},
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [{"expr": "sum(rate(container_cpu_usage_seconds_total{namespace=~\"$namespace\", pod=~\"$pod\", container!=\"\", container!=\"POD\"}[5m])) by (pod)", "legendFormat": "{{pod}}", "refId": "A"}]
        },
        {
          "title": "Memory Usage by Pod",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
          "id": 2,
          "fieldConfig": {"defaults": {"unit": "bytes", "custom": {"drawStyle": "line", "fillOpacity": 10, "lineWidth": 1}}},
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [{"expr": "sum(container_memory_working_set_bytes{namespace=~\"$namespace\", pod=~\"$pod\", container!=\"\", container!=\"POD\"}) by (pod)", "legendFormat": "{{pod}}", "refId": "A"}]
        },
        {
          "title": "CPU Requests vs Limits vs Usage",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
          "id": 3,
          "fieldConfig": {"defaults": {"unit": "short", "custom": {"drawStyle": "line", "fillOpacity": 5}}},
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(container_cpu_usage_seconds_total{namespace=~\"$namespace\", pod=~\"$pod\", container!=\"\", container!=\"POD\"}[5m])) by (pod)", "legendFormat": "Usage {{pod}}", "refId": "A"},
            {"expr": "sum(kube_pod_container_resource_requests{namespace=~\"$namespace\", pod=~\"$pod\", resource=\"cpu\"}) by (pod)", "legendFormat": "Request {{pod}}", "refId": "B"},
            {"expr": "sum(kube_pod_container_resource_limits{namespace=~\"$namespace\", pod=~\"$pod\", resource=\"cpu\"}) by (pod)", "legendFormat": "Limit {{pod}}", "refId": "C"}
          ]
        },
        {
          "title": "Memory Requests vs Limits vs Usage",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
          "id": 4,
          "fieldConfig": {"defaults": {"unit": "bytes", "custom": {"drawStyle": "line", "fillOpacity": 5}}},
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(container_memory_working_set_bytes{namespace=~\"$namespace\", pod=~\"$pod\", container!=\"\", container!=\"POD\"}) by (pod)", "legendFormat": "Usage {{pod}}", "refId": "A"},
            {"expr": "sum(kube_pod_container_resource_requests{namespace=~\"$namespace\", pod=~\"$pod\", resource=\"memory\"}) by (pod)", "legendFormat": "Request {{pod}}", "refId": "B"},
            {"expr": "sum(kube_pod_container_resource_limits{namespace=~\"$namespace\", pod=~\"$pod\", resource=\"memory\"}) by (pod)", "legendFormat": "Limit {{pod}}", "refId": "C"}
          ]
        },
        {
          "title": "Network Receive by Pod",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
          "id": 5,
          "fieldConfig": {"defaults": {"unit": "Bps", "custom": {"drawStyle": "line", "fillOpacity": 10}}},
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "list", "placement": "bottom"}},
          "targets": [{"expr": "sum(rate(container_network_receive_bytes_total{namespace=~\"$namespace\", pod=~\"$pod\"}[5m])) by (pod)", "legendFormat": "{{pod}}", "refId": "A"}]
        },
        {
          "title": "Network Transmit by Pod",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
          "id": 6,
          "fieldConfig": {"defaults": {"unit": "Bps", "custom": {"drawStyle": "line", "fillOpacity": 10}}},
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "list", "placement": "bottom"}},
          "targets": [{"expr": "sum(rate(container_network_transmit_bytes_total{namespace=~\"$namespace\", pod=~\"$pod\"}[5m])) by (pod)", "legendFormat": "{{pod}}", "refId": "A"}]
        },
        {
          "title": "Container Restarts",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
          "id": 7,
          "fieldConfig": {"defaults": {"unit": "short", "custom": {"drawStyle": "points", "pointSize": 5}}},
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "list", "placement": "bottom"}},
          "targets": [{"expr": "increase(kube_pod_container_status_restarts_total{namespace=~\"$namespace\", pod=~\"$pod\"}[1h])", "legendFormat": "{{pod}}/{{container}}", "refId": "A"}]
        },
        {
          "title": "Filesystem Usage by Pod",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
          "id": 8,
          "fieldConfig": {"defaults": {"unit": "bytes", "custom": {"drawStyle": "line", "fillOpacity": 10}}},
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "list", "placement": "bottom"}},
          "targets": [{"expr": "sum(container_fs_usage_bytes{namespace=~\"$namespace\", pod=~\"$pod\", container!=\"\", container!=\"POD\"}) by (pod)", "legendFormat": "{{pod}}", "refId": "A"}]
        }
      ],
      "schemaVersion": 39,
      "tags": ["kubernetes", "pods"],
      "templating": {
        "list": [
          {
            "current": {"selected": false, "text": "All", "value": "$__all"},
            "datasource": {"type": "prometheus", "uid": "prometheus"},
            "definition": "label_values(kube_pod_info, namespace)",
            "includeAll": true,
            "multi": true,
            "name": "namespace",
            "query": {"query": "label_values(kube_pod_info, namespace)", "refId": "StandardVariableQuery"},
            "refresh": 2,
            "type": "query"
          },
          {
            "current": {"selected": false, "text": "All", "value": "$__all"},
            "datasource": {"type": "prometheus", "uid": "prometheus"},
            "definition": "label_values(kube_pod_info{namespace=~\"$namespace\"}, pod)",
            "includeAll": true,
            "multi": true,
            "name": "pod",
            "query": {"query": "label_values(kube_pod_info{namespace=~\"$namespace\"}, pod)", "refId": "StandardVariableQuery"},
            "refresh": 2,
            "type": "query"
          }
        ]
      },
      "time": {"from": "now-1h", "to": "now"},
      "timepicker": {},
      "timezone": "",
      "title": "Pod Monitoring",
      "uid": "pod-monitoring",
      "version": 1,
      "description": "Pod-level monitoring dashboard. Based on Grafana.com dashboard 17391."
    }
