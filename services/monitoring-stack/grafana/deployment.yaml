apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      nodeSelector:
        workload-type: general
      securityContext:
        fsGroup: 472
        runAsUser: 472
        runAsGroup: 472
      containers:
        - name: grafana
          image: docker.io/grafana/grafana:11.1.0
          env:
            - name: GF_SECURITY_ADMIN_USER
              value: admin
            - name: GF_SECURITY_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-admin-secret
                  key: admin-password
            - name: GF_PATHS_PROVISIONING
              value: /etc/grafana/provisioning
            - name: GF_SERVER_ROOT_URL
              value: https://grafana.example.com/
            - name: GF_AUTH_GENERIC_OAUTH_TLS_CLIENT_CA
              value: "/etc/ssl/certs/vault-root-ca.pem"
            - name: GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH
              value: /var/lib/grafana/dashboards/home/home-overview.json
          ports:
            - name: http
              containerPort: 3000
          readinessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 30
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: "1"
              memory: 1Gi
          volumeMounts:
            - name: data
              mountPath: /var/lib/grafana
            - name: datasources
              mountPath: /etc/grafana/provisioning/datasources
            - name: dashboard-provider
              mountPath: /etc/grafana/provisioning/dashboards
            # RKE2 folder dashboards
            - name: dashboard-rke2
              mountPath: /var/lib/grafana/dashboards/rke2/rke2-cluster.json
              subPath: rke2-cluster.json
            - name: dashboard-rke-cluster
              mountPath: /var/lib/grafana/dashboards/rke2/rke-cluster.json
              subPath: rke-cluster.json
            - name: dashboard-etcd
              mountPath: /var/lib/grafana/dashboards/rke2/etcd.json
              subPath: etcd.json
            # Kubernetes folder dashboards
            - name: dashboard-cluster
              mountPath: /var/lib/grafana/dashboards/kubernetes/cluster-monitoring.json
              subPath: cluster-monitoring.json
            - name: dashboard-pods
              mountPath: /var/lib/grafana/dashboards/kubernetes/pod-monitoring.json
              subPath: pod-monitoring.json
            # Loki folder dashboards
            - name: dashboard-loki
              mountPath: /var/lib/grafana/dashboards/loki/loki-logs.json
              subPath: loki-logs.json
            - name: dashboard-loki-stack
              mountPath: /var/lib/grafana/dashboards/loki/loki-stack.json
              subPath: loki-stack.json
            # Services folder dashboards
            - name: dashboard-vault
              mountPath: /var/lib/grafana/dashboards/services/vault-overview.json
              subPath: vault-overview.json
            - name: dashboard-cnpg
              mountPath: /var/lib/grafana/dashboards/services/cnpg-cluster.json
              subPath: cnpg-cluster.json
            - name: dashboard-gitlab
              mountPath: /var/lib/grafana/dashboards/services/gitlab-overview.json
              subPath: gitlab-overview.json
            # Networking folder dashboards
            - name: dashboard-cilium
              mountPath: /var/lib/grafana/dashboards/networking/cilium-overview.json
              subPath: cilium-overview.json
            - name: dashboard-traefik
              mountPath: /var/lib/grafana/dashboards/networking/traefik-overview.json
              subPath: traefik-overview.json
            - name: dashboard-coredns
              mountPath: /var/lib/grafana/dashboards/networking/coredns.json
              subPath: coredns.json
            # Security folder dashboards
            - name: dashboard-cert-manager
              mountPath: /var/lib/grafana/dashboards/security/cert-manager.json
              subPath: cert-manager.json
            - name: dashboard-security
              mountPath: /var/lib/grafana/dashboards/security/cluster-security.json
              subPath: cluster-security.json
            # Operations folder dashboards
            - name: dashboard-operations
              mountPath: /var/lib/grafana/dashboards/operations/cluster-operations.json
              subPath: cluster-operations.json
            - name: dashboard-node-detail
              mountPath: /var/lib/grafana/dashboards/operations/node-detail.json
              subPath: node-detail.json
            - name: dashboard-storage
              mountPath: /var/lib/grafana/dashboards/operations/pv-usage.json
              subPath: pv-usage.json
            # RKE2 folder (additional)
            - name: dashboard-apiserver
              mountPath: /var/lib/grafana/dashboards/rke2/apiserver-performance.json
              subPath: apiserver-performance.json
            # Services folder (additional)
            - name: dashboard-argocd
              mountPath: /var/lib/grafana/dashboards/services/argocd-overview.json
              subPath: argocd-overview.json
            - name: dashboard-harbor
              mountPath: /var/lib/grafana/dashboards/services/harbor-overview.json
              subPath: harbor-overview.json
            - name: dashboard-mattermost
              mountPath: /var/lib/grafana/dashboards/services/mattermost-overview.json
              subPath: mattermost-overview.json
            - name: dashboard-argo-rollouts
              mountPath: /var/lib/grafana/dashboards/services/argo-rollouts-overview.json
              subPath: argo-rollouts-overview.json
            # Security folder (additional)
            - name: dashboard-keycloak
              mountPath: /var/lib/grafana/dashboards/security/keycloak-overview.json
              subPath: keycloak-overview.json
            - name: dashboard-security-advanced
              mountPath: /var/lib/grafana/dashboards/security/security-advanced.json
              subPath: security-advanced.json
            # CI/CD folder dashboards
            - name: dashboard-pipelines
              mountPath: /var/lib/grafana/dashboards/cicd/pipelines-overview.json
              subPath: pipelines-overview.json
            # Home folder dashboards
            - name: dashboard-home
              mountPath: /var/lib/grafana/dashboards/home/home-overview.json
              subPath: home-overview.json
            - name: vault-root-ca
              mountPath: /etc/ssl/certs/vault-root-ca.pem
              subPath: ca.crt
              readOnly: true
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: grafana-data
        - name: datasources
          configMap:
            name: grafana-datasources
        - name: dashboard-provider
          configMap:
            name: grafana-dashboard-provider
        - name: dashboard-rke2
          configMap:
            name: grafana-dashboard-rke2
        - name: dashboard-rke-cluster
          configMap:
            name: grafana-dashboard-rke-cluster
        - name: dashboard-cluster
          configMap:
            name: grafana-dashboard-cluster
        - name: dashboard-pods
          configMap:
            name: grafana-dashboard-pods
        - name: dashboard-etcd
          configMap:
            name: grafana-dashboard-etcd
        - name: dashboard-loki
          configMap:
            name: grafana-dashboard-loki
        - name: dashboard-loki-stack
          configMap:
            name: grafana-dashboard-loki-stack
        - name: dashboard-vault
          configMap:
            name: grafana-dashboard-vault
        - name: dashboard-cert-manager
          configMap:
            name: grafana-dashboard-cert-manager
        - name: dashboard-cilium
          configMap:
            name: grafana-dashboard-cilium
        - name: dashboard-traefik
          configMap:
            name: grafana-dashboard-traefik
        - name: dashboard-security
          configMap:
            name: grafana-dashboard-security
        - name: dashboard-operations
          configMap:
            name: grafana-dashboard-operations
        - name: dashboard-cnpg
          configMap:
            name: grafana-dashboard-cnpg
        - name: dashboard-gitlab
          configMap:
            name: grafana-dashboard-gitlab
        - name: dashboard-coredns
          configMap:
            name: grafana-dashboard-coredns
        - name: dashboard-node-detail
          configMap:
            name: grafana-dashboard-node-detail
        - name: dashboard-apiserver
          configMap:
            name: grafana-dashboard-apiserver
        - name: dashboard-storage
          configMap:
            name: grafana-dashboard-storage
        - name: dashboard-argocd
          configMap:
            name: grafana-dashboard-argocd
        - name: dashboard-harbor
          configMap:
            name: grafana-dashboard-harbor
        - name: dashboard-keycloak
          configMap:
            name: grafana-dashboard-keycloak
        - name: dashboard-mattermost
          configMap:
            name: grafana-dashboard-mattermost
        - name: dashboard-argo-rollouts
          configMap:
            name: grafana-dashboard-argo-rollouts
        - name: dashboard-home
          configMap:
            name: grafana-dashboard-home
        - name: dashboard-pipelines
          configMap:
            name: grafana-dashboard-pipelines
        - name: dashboard-security-advanced
          configMap:
            name: grafana-dashboard-security-advanced
        - name: vault-root-ca
          configMap:
            name: vault-root-ca
