apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-security-advanced
  namespace: monitoring
  labels:
    app: grafana
    grafana-dashboard: "true"
data:
  security-advanced.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "id": null,
      "links": [],
      "panels": [
        {
          "title": "",
          "type": "text",
          "gridPos": {"h": 4, "w": 24, "x": 0, "y": 0},
          "id": 1,
          "options": {
            "mode": "markdown",
            "content": "## Advanced Security Monitoring\nThreat detection, anomaly alerts, and authentication security. Covers Keycloak IAM, DNS anomalies, API abuse, lateral movement indicators, and secret access patterns."
          }
        },
        {
          "title": "Firing Security Alerts",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 0, "y": 4},
          "id": 2,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "red", "value": 1}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "count(ALERTS{alertstate=\"firing\",alertname=~\"Keycloak.*|OAuth2Proxy.*|Unusual.*|HighDNS.*|SecretAccess.*|APIServer.*\"}) OR on() vector(0)", "legendFormat": "Firing", "refId": "A"}
          ]
        },
        {
          "title": "Keycloak Login Failures (1h)",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 4, "y": 4},
          "id": 3,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 5},
                  {"color": "red", "value": 20}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "sum(increase(http_server_requests_seconds_count{job=\"keycloak\",uri=~\".*/protocol/openid-connect/token\",status=~\"4..\"}[1h])) OR on() vector(0)", "legendFormat": "Failures", "refId": "A"}
          ]
        },
        {
          "title": "RBAC Denials (1h)",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 8, "y": 4},
          "id": 4,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 10},
                  {"color": "red", "value": 50}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "sum(increase(apiserver_request_total{code=\"403\"}[1h])) OR on() vector(0)", "legendFormat": "Denials", "refId": "A"}
          ]
        },
        {
          "title": "Secret Access Rate",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 12, "y": 4},
          "id": 5,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 10},
                  {"color": "red", "value": 50}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total{resource=\"secrets\",verb=~\"GET|LIST\"}[5m]))", "legendFormat": "Secret ops/s", "refId": "A"}
          ]
        },
        {
          "title": "DNS Query Rate",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 16, "y": 4},
          "id": 6,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "blue", "value": null}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "sum(rate(coredns_dns_requests_total[5m]))", "legendFormat": "DNS qps", "refId": "A"}
          ]
        },
        {
          "title": "API Write Rate",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 20, "y": 4},
          "id": 7,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "blue", "value": null}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total{verb!~\"GET|LIST|WATCH\"}[5m]))", "legendFormat": "Writes/s", "refId": "A"}
          ]
        },
        {
          "title": "Keycloak Login Success vs Failure",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
          "id": 8,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "pointSize": 5,
                "showPoints": "auto"
              }
            },
            "overrides": [
              {
                "matcher": {"id": "byRegexp", "options": "Fail.*"},
                "properties": [
                  {"id": "color", "value": {"mode": "fixed", "fixedColor": "red"}}
                ]
              }
            ]
          },
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(http_server_requests_seconds_count{job=\"keycloak\",uri=~\".*/protocol/openid-connect/token\",status=\"200\"}[5m]))", "legendFormat": "Success", "refId": "A"},
            {"expr": "sum(rate(http_server_requests_seconds_count{job=\"keycloak\",uri=~\".*/protocol/openid-connect/token\",status=~\"4..\"}[5m]))", "legendFormat": "Fail", "refId": "B"}
          ]
        },
        {
          "title": "Login Error Breakdown",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
          "id": 9,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "pointSize": 5,
                "showPoints": "auto"
              }
            }
          },
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum by (status) (rate(http_server_requests_seconds_count{job=\"keycloak\",uri=~\".*/protocol/openid-connect/token\",status=~\"4..\"}[5m]))", "legendFormat": "{{status}}", "refId": "A"}
          ]
        },
        {
          "title": "API Request Rate by Verb",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
          "id": 10,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "pointSize": 5,
                "showPoints": "auto"
              }
            }
          },
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total[5m])) by (verb)", "legendFormat": "{{verb}}", "refId": "A"}
          ]
        },
        {
          "title": "403 Forbidden Responses",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
          "id": 11,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "noValue": "0",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "pointSize": 5,
                "showPoints": "auto"
              }
            }
          },
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total{code=\"403\"}[5m])) by (resource, verb)", "legendFormat": "{{verb}} {{resource}}", "refId": "A"}
          ]
        },
        {
          "title": "DNS Query Rate by Type",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
          "id": 12,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "pointSize": 5,
                "showPoints": "auto"
              }
            }
          },
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(coredns_dns_requests_total[5m])) by (type)", "legendFormat": "{{type}}", "refId": "A"}
          ]
        },
        {
          "title": "DNS Response Errors",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
          "id": 13,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "pointSize": 5,
                "showPoints": "auto"
              }
            }
          },
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(coredns_dns_responses_total{rcode!=\"NOERROR\"}[5m])) by (rcode)", "legendFormat": "{{rcode}}", "refId": "A"}
          ]
        },
        {
          "title": "Secret Access by Verb",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 32},
          "id": 14,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "pointSize": 5,
                "showPoints": "auto"
              }
            }
          },
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total{resource=\"secrets\"}[5m])) by (verb)", "legendFormat": "{{verb}}", "refId": "A"}
          ]
        },
        {
          "title": "Service Account Token Requests",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 32},
          "id": 15,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "pointSize": 5,
                "showPoints": "auto"
              }
            }
          },
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total{resource=\"serviceaccounts\",subresource=\"token\"}[5m])) by (verb)", "legendFormat": "{{verb}}", "refId": "A"}
          ]
        },
        {
          "title": "Pod Network Traffic Anomalies",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 40},
          "id": 16,
          "fieldConfig": {
            "defaults": {
              "unit": "Bps",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "pointSize": 5,
                "showPoints": "auto"
              }
            }
          },
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "topk(10, sum by (namespace, pod) (rate(container_network_transmit_bytes_total[5m])))", "legendFormat": "{{namespace}}/{{pod}}", "refId": "A"}
          ]
        },
        {
          "title": "Container Restarts (potential escape attempts)",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 40},
          "id": 17,
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "pointSize": 5,
                "showPoints": "auto"
              }
            }
          },
          "options": {"tooltip": {"mode": "multi"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "topk(10, increase(kube_pod_container_status_restarts_total[1h]) > 3)", "legendFormat": "{{namespace}}/{{pod}}", "refId": "A"}
          ]
        },
        {
          "title": "Keycloak Auth Failures (Loki)",
          "type": "logs",
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 10, "w": 12, "x": 0, "y": 48},
          "id": 18,
          "options": {
            "showTime": true,
            "showLabels": true,
            "showCommonLabels": false,
            "wrapLogMessage": true,
            "prettifyLogMessage": false,
            "enableLogDetails": true,
            "sortOrder": "Descending",
            "dedupStrategy": "none"
          },
          "targets": [
            {"expr": "{namespace=\"keycloak\"} |~ \"LOGIN_ERROR|WARN|authentication failed\"", "refId": "A"}
          ]
        },
        {
          "title": "RBAC/Forbidden Logs (Loki)",
          "type": "logs",
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 10, "w": 12, "x": 12, "y": 48},
          "id": 19,
          "options": {
            "showTime": true,
            "showLabels": true,
            "showCommonLabels": false,
            "wrapLogMessage": true,
            "prettifyLogMessage": false,
            "enableLogDetails": true,
            "sortOrder": "Descending",
            "dedupStrategy": "none"
          },
          "targets": [
            {"expr": "{namespace=\"kube-system\", container=\"kube-apiserver\"} |= \"Forbidden\"", "refId": "A"}
          ]
        }
      ],
      "schemaVersion": 39,
      "tags": ["security", "keycloak", "threat-detection", "anomaly"],
      "templating": {"list": []},
      "time": {"from": "now-1h", "to": "now"},
      "timepicker": {},
      "timezone": "",
      "title": "Advanced Security Monitoring",
      "uid": "security-advanced",
      "version": 1,
      "description": "Advanced security monitoring dashboard covering Keycloak authentication analysis, API abuse detection, DNS anomaly detection, secret and RBAC monitoring, container security indicators, and log-based threat hunting via Loki."
    }
