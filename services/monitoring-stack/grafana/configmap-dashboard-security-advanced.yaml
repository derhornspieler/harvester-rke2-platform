apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-security-advanced
  namespace: monitoring
  labels:
    app: grafana
    grafana_dashboard: "1"
  annotations:
    grafana_folder: Security
data:
  security-advanced.json: |
    {
      "annotations": {"list": []},
      "description": "Security operations dashboard covering threat detection, Keycloak authentication monitoring, RBAC audit, DNS anomaly analysis, Cilium policy enforcement, secret access patterns, and log-based threat hunting.",
      "editable": true,
      "id": null,
      "links": [
        {"title": "Back to Home", "url": "/d/home-overview/cluster-home?orgId=1", "icon": "external link", "targetBlank": false, "type": "link"}
      ],
      "panels": [
        {
          "title": "",
          "type": "text",
          "gridPos": {"h": 3, "w": 24, "x": 0, "y": 0},
          "id": 1,
          "options": {
            "mode": "markdown",
            "content": "## Security Operations\nThreat detection, authentication monitoring, and security compliance. Covers Keycloak IAM, DNS anomalies, API abuse, RBAC denials, secret access patterns, Cilium policy drops, and audit logging."
          }
        },
        {
          "title": "Firing Security Alerts",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 0, "y": 3},
          "id": 2,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "red", "value": 1}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "count(ALERTS{alertstate=\"firing\",alertname=~\"Keycloak.*|OAuth2Proxy.*|Unusual.*|HighDNS.*|SecretAccess.*|APIServer.*\"}) OR on() vector(0)", "legendFormat": "Firing", "refId": "A"}
          ]
        },
        {
          "title": "Keycloak Login Failures (1h)",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 4, "y": 3},
          "id": 3,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 5},
                  {"color": "red", "value": 20}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "sum(increase(http_server_requests_seconds_count{job=\"keycloak\",uri=~\".*/protocol/openid-connect/token\",status=~\"4..\"}[1h])) OR on() vector(0)", "legendFormat": "Failures", "refId": "A"}
          ]
        },
        {
          "title": "RBAC Denials (1h)",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 8, "y": 3},
          "id": 4,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 10},
                  {"color": "red", "value": 50}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "sum(increase(apiserver_request_total{code=\"403\"}[1h])) OR on() vector(0)", "legendFormat": "Denials", "refId": "A"}
          ]
        },
        {
          "title": "Secret Access Rate",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 12, "y": 3},
          "id": 5,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 10},
                  {"color": "red", "value": 50}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total{resource=\"secrets\",verb=~\"GET|LIST\"}[5m]))", "legendFormat": "Secret ops/s", "refId": "A"}
          ]
        },
        {
          "title": "DNS Query Rate",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 16, "y": 3},
          "id": 6,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "blue", "value": null}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "sum(rate(coredns_dns_requests_total[5m]))", "legendFormat": "DNS qps", "refId": "A"}
          ]
        },
        {
          "title": "API Write Rate",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 20, "y": 3},
          "id": 7,
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "blue", "value": null}
                ]
              },
              "noValue": "0"
            }
          },
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total{verb!~\"GET|LIST|WATCH\"}[5m]))", "legendFormat": "Writes/s", "refId": "A"}
          ]
        },
        {
          "title": "Keycloak Login Success vs Failure",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 7},
          "id": 8,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "stacking": {"mode": "none"},
                "spanNulls": false,
                "thresholdsStyle": {"mode": "line"}
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "red", "value": 0.5}
                ]
              }
            },
            "overrides": [
              {
                "matcher": {"id": "byRegexp", "options": "Fail.*"},
                "properties": [
                  {"id": "color", "value": {"mode": "fixed", "fixedColor": "red"}}
                ]
              }
            ]
          },
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(http_server_requests_seconds_count{job=\"keycloak\",uri=~\".*/protocol/openid-connect/token\",status=\"200\"}[5m]))", "legendFormat": "Success", "refId": "A"},
            {"expr": "sum(rate(http_server_requests_seconds_count{job=\"keycloak\",uri=~\".*/protocol/openid-connect/token\",status=~\"4..\"}[5m]))", "legendFormat": "Fail", "refId": "B"}
          ]
        },
        {
          "title": "Login Error Breakdown",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 7},
          "id": 9,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "stacking": {"mode": "none"},
                "spanNulls": false
              }
            }
          },
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum by (status) (rate(http_server_requests_seconds_count{job=\"keycloak\",uri=~\".*/protocol/openid-connect/token\",status=~\"4..\"}[5m]))", "legendFormat": "{{status}}", "refId": "A"}
          ]
        },
        {
          "title": "API Request Rate by Verb",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 15},
          "id": 10,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "stacking": {"mode": "none"},
                "spanNulls": false,
                "thresholdsStyle": {"mode": "line"}
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 100}
                ]
              }
            }
          },
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total[5m])) by (verb)", "legendFormat": "{{verb}}", "refId": "A"}
          ]
        },
        {
          "title": "403 Forbidden Responses",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 15},
          "id": 11,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "noValue": "0",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "stacking": {"mode": "none"},
                "spanNulls": false
              }
            }
          },
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total{code=\"403\"}[5m])) by (resource, verb)", "legendFormat": "{{verb}} {{resource}}", "refId": "A"}
          ]
        },
        {
          "title": "DNS Query Rate by Type",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 23},
          "id": 12,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "stacking": {"mode": "none"},
                "spanNulls": false,
                "thresholdsStyle": {"mode": "line"}
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "red", "value": 5000}
                ]
              }
            }
          },
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(coredns_dns_requests_total[5m])) by (type)", "legendFormat": "{{type}}", "refId": "A"}
          ]
        },
        {
          "title": "DNS Response Errors",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 23},
          "id": 13,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "stacking": {"mode": "none"},
                "spanNulls": false
              }
            }
          },
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(coredns_dns_responses_total{rcode!=\"NOERROR\"}[5m])) by (rcode)", "legendFormat": "{{rcode}}", "refId": "A"}
          ]
        },
        {
          "title": "Secret Access by Verb",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 31},
          "id": 14,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "stacking": {"mode": "none"},
                "spanNulls": false,
                "thresholdsStyle": {"mode": "line"}
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 50}
                ]
              }
            }
          },
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total{resource=\"secrets\"}[5m])) by (verb)", "legendFormat": "{{verb}}", "refId": "A"}
          ]
        },
        {
          "title": "Service Account Token Requests",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 31},
          "id": 15,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "stacking": {"mode": "none"},
                "spanNulls": false
              }
            }
          },
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum(rate(apiserver_request_total{resource=\"serviceaccounts\",subresource=\"token\"}[5m])) by (verb)", "legendFormat": "{{verb}}", "refId": "A"}
          ]
        },
        {
          "title": "Cilium Policy Drops",
          "description": "Empty when no violations detected \u2014 this is healthy.",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 39},
          "id": 16,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "stacking": {"mode": "none"},
                "spanNulls": false
              }
            }
          },
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "rate(cilium_drop_count_total{reason=~\"POLICY_DENIED.*\"}[5m])", "legendFormat": "{{reason}} - {{node}}", "refId": "A"}
          ]
        },
        {
          "title": "Network Policy Drops by Reason",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 39},
          "id": 17,
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 10,
                "lineWidth": 1,
                "stacking": {"mode": "none"},
                "spanNulls": false
              }
            }
          },
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [
            {"expr": "sum by (reason) (rate(cilium_drop_count_total[5m]))", "legendFormat": "{{reason}}", "refId": "A"}
          ]
        },
        {
          "title": "Keycloak Auth Failures (Loki)",
          "type": "logs",
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 10, "w": 12, "x": 0, "y": 47},
          "id": 18,
          "options": {
            "showTime": true,
            "showLabels": true,
            "showCommonLabels": false,
            "wrapLogMessage": true,
            "prettifyLogMessage": false,
            "enableLogDetails": true,
            "sortOrder": "Descending",
            "dedupStrategy": "none"
          },
          "targets": [
            {"expr": "{namespace=\"keycloak\"} |~ \"LOGIN_ERROR|WARN|authentication failed\"", "refId": "A"}
          ]
        },
        {
          "title": "RBAC/Forbidden Logs (Loki)",
          "type": "logs",
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 10, "w": 12, "x": 12, "y": 47},
          "id": 19,
          "options": {
            "showTime": true,
            "showLabels": true,
            "showCommonLabels": false,
            "wrapLogMessage": true,
            "prettifyLogMessage": false,
            "enableLogDetails": true,
            "sortOrder": "Descending",
            "dedupStrategy": "none"
          },
          "targets": [
            {"expr": "{namespace=\"kube-system\", container=\"kube-apiserver\"} |= \"Forbidden\"", "refId": "A"}
          ]
        }
      ],
      "schemaVersion": 39,
      "tags": ["security", "keycloak", "threat-detection", "cilium", "rbac"],
      "templating": {"list": []},
      "time": {"from": "now-1h", "to": "now"},
      "timepicker": {},
      "timezone": "",
      "title": "Security Operations",
      "uid": "security-advanced",
      "version": 1
    }
