apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-cnpg
  namespace: monitoring
  labels:
    app: grafana
    grafana_dashboard: "1"
  annotations:
    grafana_folder: Services
data:
  cnpg-cluster.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "id": null,
      "links": [{"title": "Back to Home", "url": "/d/home-overview/cluster-home?orgId=1", "icon": "external link", "targetBlank": false, "type": "link"}],
      "tags": ["cloudnativepg", "postgresql", "cnpg", "platform"],
      "templating": {
        "list": [
          {
            "name": "cluster",
            "type": "query",
            "datasource": {"type": "prometheus", "uid": "prometheus"},
            "query": "label_values(cnpg_pg_settings_setting, cnpg_cluster)",
            "refresh": 2,
            "includeAll": false,
            "multi": false,
            "sort": 1,
            "current": {},
            "label": "Cluster"
          }
        ]
      },
      "time": {"from": "now-6h", "to": "now"},
      "timepicker": {},
      "timezone": "browser",
      "title": "CloudNativePG Cluster",
      "uid": "cnpg-cluster",
      "version": 1,
      "schemaVersion": 39,
      "panels": [
        {
          "title": "PostgreSQL Instances Up",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
          "id": 1,
          "fieldConfig": {"defaults": {"thresholds": {"mode": "absolute", "steps": [{"color": "red", "value": null}, {"color": "orange", "value": 1}, {"color": "green", "value": 2}]}}},
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [{"expr": "count(up{job=\"cnpg-postgresql\", cnpg_cluster=\"$cluster\"} == 1)", "legendFormat": "Instances Up", "refId": "A"}]
        },
        {
          "title": "Primary Instance",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
          "id": 2,
          "fieldConfig": {"defaults": {"thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}, "mappings": [{"type": "value", "options": {"0": {"text": "PRIMARY", "color": "green"}, "1": {"text": "REPLICA", "color": "blue"}}}]}},
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [{"expr": "cnpg_pg_replication_in_recovery{cnpg_cluster=\"$cluster\"} == 0", "legendFormat": "{{pod}}", "refId": "A"}]
        },
        {
          "title": "Replication Lag",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
          "id": 3,
          "fieldConfig": {"defaults": {"unit": "s", "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "orange", "value": 1}, {"color": "red", "value": 5}]}}},
          "options": {"colorMode": "background", "graphMode": "area", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [{"expr": "max(cnpg_pg_replication_lag{cnpg_cluster=\"$cluster\"})", "legendFormat": "Max Lag", "refId": "A"}]
        },
        {
          "title": "Active Connections",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
          "id": 4,
          "fieldConfig": {"defaults": {"thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "orange", "value": 80}, {"color": "red", "value": 150}]}}},
          "options": {"colorMode": "background", "graphMode": "area", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [{"expr": "sum(cnpg_backends_total{cnpg_cluster=\"$cluster\"})", "legendFormat": "Connections", "refId": "A"}]
        },
        {
          "title": "Transaction Rate",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
          "id": 5,
          "fieldConfig": {"defaults": {"unit": "ops", "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 15, "pointSize": 5, "showPoints": "never", "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}, "overrides": [{"matcher": {"id": "byName", "options": "Rollbacks"}, "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]}]},
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"expr": "rate(cnpg_pg_stat_database_xact_commit{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "Commits - {{datname}}", "refId": "A"},
            {"expr": "rate(cnpg_pg_stat_database_xact_rollback{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "Rollbacks - {{datname}}", "refId": "B"}
          ]
        },
        {
          "title": "Rows Returned/Fetched",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
          "id": 6,
          "fieldConfig": {"defaults": {"unit": "rowsps", "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 15, "pointSize": 5, "showPoints": "never", "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}},
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"expr": "rate(cnpg_pg_stat_database_tup_returned{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "Returned - {{datname}}", "refId": "A"},
            {"expr": "rate(cnpg_pg_stat_database_tup_fetched{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "Fetched - {{datname}}", "refId": "B"}
          ]
        },
        {
          "title": "Rows Inserted/Updated/Deleted",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
          "id": 7,
          "fieldConfig": {"defaults": {"unit": "rowsps", "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 15, "pointSize": 5, "showPoints": "never", "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}, "overrides": [{"matcher": {"id": "byRegexp", "options": "Deleted.*"}, "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]}]},
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"expr": "rate(cnpg_pg_stat_database_tup_inserted{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "Inserted - {{datname}}", "refId": "A"},
            {"expr": "rate(cnpg_pg_stat_database_tup_updated{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "Updated - {{datname}}", "refId": "B"},
            {"expr": "rate(cnpg_pg_stat_database_tup_deleted{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "Deleted - {{datname}}", "refId": "C"}
          ]
        },
        {
          "title": "Connection Usage %",
          "type": "gauge",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
          "id": 8,
          "fieldConfig": {"defaults": {"unit": "percent", "min": 0, "max": 100, "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "orange", "value": 70}, {"color": "red", "value": 90}]}}},
          "options": {"reduceOptions": {"calcs": ["lastNotNull"]}, "showThresholdLabels": false, "showThresholdMarkers": true},
          "targets": [{"expr": "sum(cnpg_backends_total{cnpg_cluster=\"$cluster\"}) / max(cnpg_pg_settings_setting{name=\"max_connections\",cnpg_cluster=\"$cluster\"}) * 100", "legendFormat": "Usage", "refId": "A"}]
        },
        {
          "title": "Replication Lag Over Time",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 20},
          "id": 9,
          "fieldConfig": {"defaults": {"unit": "s", "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 15, "pointSize": 5, "showPoints": "never", "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false, "thresholdsStyle": {"mode": "line+area"}}, "thresholds": {"mode": "absolute", "steps": [{"color": "transparent", "value": null}, {"color": "red", "value": 30}]}}},
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [{"expr": "cnpg_pg_replication_lag{cnpg_cluster=\"$cluster\"}", "legendFormat": "{{pod}}", "refId": "A"}]
        },
        {
          "title": "Database Size",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 20},
          "id": 10,
          "fieldConfig": {"defaults": {"unit": "bytes", "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 15, "pointSize": 5, "showPoints": "never", "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}},
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [{"expr": "cnpg_pg_database_size_bytes{cnpg_cluster=\"$cluster\"}", "legendFormat": "{{datname}}", "refId": "A"}]
        },
        {
          "title": "WAL Files",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 44},
          "id": 11,
          "fieldConfig": {"defaults": {"custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 15, "pointSize": 5, "showPoints": "never", "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}},
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"expr": "cnpg_collector_pg_wal{cnpg_cluster=\"$cluster\", value=\"count\"}", "legendFormat": "WAL Files - {{instance}}", "refId": "A"},
            {"expr": "cnpg_collector_pg_wal{cnpg_cluster=\"$cluster\", value=\"keep\"}", "legendFormat": "WAL Keep - {{instance}}", "refId": "B"},
            {"expr": "rate(cnpg_collector_wal_bytes{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "WAL Write Rate - {{instance}}", "refId": "C"},
            {"expr": "rate(cnpg_collector_wal_records{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "WAL Records/s - {{instance}}", "refId": "D"}
          ]
        },
        {
          "title": "Block I/O (Read vs Hit)",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 28},
          "id": 13,
          "fieldConfig": {"defaults": {"unit": "ops", "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 15, "pointSize": 5, "showPoints": "never", "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}},
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"expr": "rate(cnpg_pg_stat_database_blks_read{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "Disk Reads - {{datname}}", "refId": "A"},
            {"expr": "rate(cnpg_pg_stat_database_blks_hit{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "Cache Hits - {{datname}}", "refId": "B"}
          ]
        },
        {
          "title": "Temp Files & Bytes Written",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 28},
          "id": 14,
          "fieldConfig": {"defaults": {"unit": "Bps", "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 15, "pointSize": 5, "showPoints": "never", "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}, "overrides": [{"matcher": {"id": "byRegexp", "options": "Temp Files.*"}, "properties": [{"id": "unit", "value": "short"}, {"id": "custom.axisPlacement", "value": "right"}]}]},
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"expr": "rate(cnpg_pg_stat_database_temp_bytes{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "Temp Bytes/s - {{datname}}", "refId": "A"},
            {"expr": "rate(cnpg_pg_stat_database_temp_files{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "Temp Files/s - {{datname}}", "refId": "B"}
          ]
        },
        {
          "title": "Cache Hit Ratio",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 44},
          "id": 12,
          "fieldConfig": {"defaults": {"unit": "percent", "min": 0, "max": 100, "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 15, "pointSize": 5, "showPoints": "never", "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}, "thresholds": {"mode": "absolute", "steps": [{"color": "red", "value": null}, {"color": "orange", "value": 90}, {"color": "green", "value": 99}]}}},
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [{"expr": "cnpg_pg_stat_database_blks_hit{cnpg_cluster=\"$cluster\"} / (cnpg_pg_stat_database_blks_hit{cnpg_cluster=\"$cluster\"} + cnpg_pg_stat_database_blks_read{cnpg_cluster=\"$cluster\"}) * 100", "legendFormat": "{{datname}}", "refId": "A"}]
        },
        {
          "title": "WAL Archive Rate",
          "description": "WAL files archived per second",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 58},
          "id": 20,
          "fieldConfig": {"defaults": {"unit": "ops", "custom": {"drawStyle": "line", "fillOpacity": 15, "lineWidth": 1, "lineInterpolation": "smooth", "stacking": {"mode": "none"}, "spanNulls": false}}},
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"]}},
          "targets": [{"expr": "rate(cnpg_pg_stat_archiver_archived_count{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "archived {{pod}}", "refId": "A"}, {"expr": "rate(cnpg_pg_stat_archiver_failed_count{cnpg_cluster=\"$cluster\"}[5m])", "legendFormat": "failed {{pod}}", "refId": "B"}]
        }
      ]
    }
