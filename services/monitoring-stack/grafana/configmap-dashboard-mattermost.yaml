apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-mattermost
  namespace: monitoring
  labels:
    app: grafana
    grafana_dashboard: "1"
  annotations:
    grafana_folder: Services
data:
  mattermost-overview.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "id": null,
      "links": [{"title": "Back to Home", "url": "/d/home-overview/cluster-home?orgId=1", "icon": "external link", "targetBlank": false, "type": "link"}],
      "panels": [
        {
          "title": "",
          "type": "text",
          "gridPos": {"h": 3, "w": 24, "x": 0, "y": 0},
          "id": 20,
          "options": {
            "mode": "markdown",
            "content": "### Kubernetes-Level Health Metrics Only\nMattermost app-level metrics are not enabled. To enable, set `MetricsSettings.Enable: true` in the Mattermost config. Currently showing Kubernetes-level health metrics only.",
            "code": {"language": "plaintext", "showLineNumbers": false}
          }
        },
        {
          "title": "Deployment Readiness",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 6, "x": 0, "y": 3},
          "id": 1,
          "fieldConfig": {"defaults": {"unit": "percentunit", "thresholds": {"mode": "absolute", "steps": [{"color": "red", "value": null}, {"color": "yellow", "value": 0.5}, {"color": "green", "value": 1}]}, "mappings": [], "min": 0, "max": 1}},
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [{"expr": "kube_deployment_status_replicas_ready{deployment=~\"mattermost.*\"} / kube_deployment_spec_replicas{deployment=~\"mattermost.*\"}", "legendFormat": "{{deployment}}", "refId": "A"}]
        },
        {
          "title": "Pod Restarts (1h)",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 6, "x": 6, "y": 3},
          "id": 2,
          "fieldConfig": {"defaults": {"unit": "short", "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 1}]}, "custom": {"drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}},
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "list", "placement": "bottom"}},
          "targets": [{"expr": "increase(kube_pod_container_status_restarts_total{pod=~\"mattermost.*\"}[1h])", "legendFormat": "{{pod}}", "refId": "A"}]
        },
        {
          "title": "CPU Usage",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 6, "x": 12, "y": 3},
          "id": 3,
          "fieldConfig": {"defaults": {"unit": "short", "custom": {"drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}},
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "list", "placement": "bottom"}},
          "targets": [{"expr": "rate(container_cpu_usage_seconds_total{pod=~\"mattermost.*\",container!=\"\"}[5m])", "legendFormat": "{{pod}} / {{container}}", "refId": "A"}]
        },
        {
          "title": "Memory Usage",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 3},
          "id": 4,
          "fieldConfig": {"defaults": {"unit": "bytes", "custom": {"drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}},
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "list", "placement": "bottom"}},
          "targets": [{"expr": "container_memory_working_set_bytes{pod=~\"mattermost.*\",container!=\"\"}", "legendFormat": "{{pod}} / {{container}}", "refId": "A"}]
        },
        {
          "title": "Network I/O",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 7},
          "id": 5,
          "fieldConfig": {"defaults": {"unit": "Bps", "custom": {"drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}},
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "list", "placement": "bottom"}},
          "targets": [
            {"expr": "rate(container_network_receive_bytes_total{pod=~\"mattermost.*\"}[5m])", "legendFormat": "{{pod}} RX", "refId": "A"},
            {"expr": "rate(container_network_transmit_bytes_total{pod=~\"mattermost.*\"}[5m])", "legendFormat": "{{pod}} TX", "refId": "B"}
          ]
        },
        {
          "title": "Pod Restarts (Timeseries)",
          "type": "timeseries",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 7},
          "id": 6,
          "fieldConfig": {"defaults": {"unit": "short", "custom": {"drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "stacking": {"mode": "none"}, "spanNulls": false}}},
          "options": {"tooltip": {"mode": "multi", "sort": "desc"}, "legend": {"displayMode": "list", "placement": "bottom"}},
          "targets": [{"expr": "increase(kube_pod_container_status_restarts_total{pod=~\"mattermost.*\"}[1h])", "legendFormat": "{{pod}} / {{container}}", "refId": "A"}]
        },
        {
          "title": "Deployment Ready",
          "description": "Mattermost deployment readiness based on replica count",
          "type": "stat",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
          "id": 9,
          "fieldConfig": {"defaults": {"noValue": "0", "thresholds": {"mode": "absolute", "steps": [{"color": "red", "value": null}, {"color": "green", "value": 1}]}, "mappings": [{"type": "value", "options": {"0": {"text": "DOWN", "color": "red"}}}, {"type": "range", "options": {"from": 1, "to": 999, "result": {"text": "UP", "color": "green"}}}]}},
          "options": {"colorMode": "background", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
          "targets": [{"expr": "kube_deployment_status_replicas_ready{deployment=~\"mattermost.*\"}", "legendFormat": "", "refId": "A"}]
        },
        {
          "title": "Mattermost Error Logs",
          "type": "logs",
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 10, "w": 24, "x": 0, "y": 15},
          "id": 11,
          "options": {
            "showLabels": true,
            "showTime": true,
            "sortOrder": "Descending",
            "wrapLogMessage": true,
            "dedupStrategy": "none",
            "enableLogDetails": true,
            "prettifyLogMessage": false
          },
          "targets": [{"expr": "{namespace=\"mattermost\"} |= \"error\" | logfmt | level = \"error\"", "legendFormat": "", "refId": "A"}]
        }
      ],
      "schemaVersion": 39,
      "tags": ["mattermost", "messaging", "collaboration"],
      "templating": {"list": []},
      "time": {"from": "now-1h", "to": "now"},
      "timepicker": {},
      "timezone": "",
      "title": "Mattermost Overview",
      "uid": "mattermost-overview",
      "version": 2,
      "description": "Mattermost monitoring dashboard showing Kubernetes-level health metrics (deployment readiness, pod restarts, CPU, memory, network I/O) and error logs via Loki. App-level metrics require MetricsSettings.Enable: true in Mattermost config."
    }
