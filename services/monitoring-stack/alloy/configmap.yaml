apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: monitoring
  labels:
    app: alloy
data:
  config.alloy: |
    // ============================================================
    // Grafana Alloy configuration for RKE2 cluster log collection
    // ============================================================

    // Loki write endpoint
    loki.write "default" {
      endpoint {
        url = "http://loki.monitoring.svc:3100/loki/api/v1/push"
      }
      external_labels = {
        cluster = "rke2-production",
      }
    }

    // ============================================================
    // 1. Pod logs - Kubernetes service discovery
    // ============================================================
    discovery.kubernetes "pods" {
      role = "pod"
    }

    // Only collect logs from pods on the same node as this Alloy instance
    discovery.relabel "pod_logs" {
      targets = discovery.kubernetes.pods.targets

      rule {
        source_labels = ["__meta_kubernetes_pod_node_name"]
        target_label  = "__host__"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_node_name"]
        action        = "keep"
        regex         = env("HOSTNAME")
      }

      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_container_name"]
        target_label  = "container"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_node_name"]
        target_label  = "node"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_label_app"]
        target_label  = "app"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
        target_label  = "app_name"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_component"]
        target_label  = "component"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_instance"]
        target_label  = "instance_name"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_label_cnpg_io_cluster"]
        target_label  = "cnpg_cluster"
      }
    }

    loki.source.kubernetes "pod_logs" {
      targets    = discovery.relabel.pod_logs.output
      forward_to = [loki.write.default.receiver]
    }

    // ============================================================
    // 2. Kubernetes events
    // ============================================================
    loki.source.kubernetes_events "events" {
      log_format = "logfmt"
      forward_to = [loki.write.default.receiver]
    }

    // ============================================================
    // 3. Journal logs - RKE2 systemd services
    // ============================================================
    loki.source.journal "rke2_journal" {
      path          = "/var/log/journal"
      relabel_rules = loki.relabel.journal_labels.rules
      forward_to    = [loki.write.default.receiver]
      matches       = "_SYSTEMD_UNIT=rke2-server.service _SYSTEMD_UNIT=rke2-agent.service"
    }

    loki.relabel "journal_labels" {
      forward_to = []

      rule {
        source_labels = ["__journal__systemd_unit"]
        target_label  = "unit"
      }

      rule {
        source_labels = ["__journal__hostname"]
        target_label  = "node"
      }
    }
