# Developer's Guide

Quick-start guide for setting up and operating the RKE2 cluster. For detailed architecture and operations, see the linked docs.

## Table of Contents

- [File Structure](#file-structure)
- [Prerequisites](#prerequisites)
- [Deployment](#deployment)
- [Deploying Workloads](#deploying-workloads)
- [Secret Management](#secret-management)
- [Further Reading](#further-reading)

---

## File Structure

```
.
├── README.md                 # Platform overview and documentation index
├── DEVELOPERS_GUIDE.md       # This file
├── cluster/                  # Terraform infrastructure
│   ├── versions.tf           # Terraform/provider version constraints, K8s backend
│   ├── providers.tf          # Rancher2 + Harvester provider config
│   ├── variables.tf          # All input variables with defaults
│   ├── terraform.tfvars.example  # Example variable values
│   ├── cloud_credential.tf   # Data source for existing Harvester cloud credential
│   ├── image.tf              # Rocky 9 image upload to Harvester
│   ├── machine_config.tf     # Machine configs + cloud-init (CP vs worker split)
│   ├── cluster.tf            # RKE2 cluster resource (pools, chart values, CNI config)
│   ├── outputs.tf            # Cluster ID, image ID, credential ID
│   └── terraform.sh          # Wrapper script (secret management + terraform commands)
├── services/                 # Kubernetes workloads
│   ├── monitoring-stack/     # Prometheus, Grafana, Loki, Alloy, cert-manager
│   ├── vault/                # Vault HA (3-replica Raft)
│   ├── cert-manager/         # ClusterIssuer, RBAC
│   ├── keycloak/             # Keycloak HA IDP
│   ├── argo/                 # ArgoCD + Argo Rollouts
│   ├── harbor/               # Harbor HA container registry
│   ├── mattermost/           # Mattermost team messaging
│   └── kasm/                 # Kasm virtual desktops
└── docs/                     # Architecture and flow diagrams
    ├── architecture.md       # Node pools, infrastructure stack, storage
    ├── service-architecture.md # All 8 services, dependencies, resources
    ├── network-flow.md       # Cilium, L2, Traefik routing, dual-NIC
    ├── data-flow.md          # Monitoring pipeline, cert lifecycle, GitOps
    ├── deployment-flow.md    # Terraform + 5-phase service deployment
    ├── decision-tree.md      # Ingress, pool, auth, database decisions
    ├── security.md           # TLS chain, auth matrix, RBAC, security debt
    ├── troubleshooting.md    # Categorized issues and fixes
    ├── operations-runbook.md # Day-2 ops: unseal, backup, scaling, upgrades
    ├── vault-ha.md           # Vault HA migration plan (implemented)
    ├── vault-credential-storage.md  # Vault KV + ESO migration plan
    └── golden-image-plan.md  # Pre-baked Rocky 9 image plan
```

---

## Prerequisites

1. **Rancher server** with Harvester virtualization management enabled
2. **Rancher API key** (global scope) -- Rancher UI > User Avatar > Account & API Keys
3. **Harvester context in `~/.kube/config`** -- The deploy script auto-extracts `cluster/kubeconfig-harvester.yaml` from this context. Default context name is `harvester` (configurable via `HARVESTER_CONTEXT` in `scripts/.env`)
4. **Harvester cloud credential** created in Rancher (Rancher UI > Cluster Management > Cloud Credentials)
5. **Tools:** `terraform >= 1.5.0`, `kubectl`, `jq`, `helm`, `openssl`, `curl`

> **Note:** Both `cluster/kubeconfig-harvester.yaml` and `cluster/harvester-cloud-provider-kubeconfig` are auto-generated by `deploy-cluster.sh` if missing. The cloud provider kubeconfig is generated via the Rancher API using values from `terraform.tfvars`.

<details>
<summary>Manual Reference: Cloud provider kubeconfig generation</summary>

If you need to generate the cloud provider kubeconfig manually (e.g., without `deploy-cluster.sh`):

```bash
curl -sk -X POST \
  "https://<RANCHER_URL>/k8s/clusters/<HARVESTER_MGMT_CLUSTER_ID>/v1/harvester/kubeconfig" \
  -H 'Content-Type: application/json' \
  -u '<ACCESS_KEY>:<SECRET_KEY>' \
  -d '{"clusterRoleName":"harvesterhci.io:cloudprovider",
       "namespace":"<VM_NAMESPACE>",
       "serviceAccountName":"<CLUSTER_NAME>"}' \
  > cluster/harvester-cloud-provider-kubeconfig
```

</details>

---

## Deployment

### First-time setup

```bash
cd cluster
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your actual values

./terraform.sh init       # Creates K8s namespace, pushes secrets, initializes backend
./terraform.sh plan       # Preview changes
./terraform.sh apply      # Deploy (takes ~20-30 minutes)
```

### Day-2 operations

```bash
cd cluster
./terraform.sh plan       # Always preview first
./terraform.sh apply      # Apply changes (in-place when possible, rolling replace for node changes)
./terraform.sh destroy    # Tear down entire cluster
```

> **Important:** `terraform.sh` runs `pull_secrets` before every terraform command, which overwrites your local `terraform.tfvars`. Always run `./terraform.sh push-secrets` after editing `terraform.tfvars` locally. All commands are run from the `cluster/` directory.

### State management

Terraform state is stored in a Kubernetes secret on the Harvester cluster (`terraform-state` namespace, secret `tfstate-default-rke2-cluster`). The `cluster/terraform.sh` wrapper manages syncing sensitive files (tfvars, kubeconfigs, vault-init.json) as K8s secrets.

### Service deployment

After the cluster is ready, deploy services in 5 phases. See [docs/deployment-flow.md](docs/deployment-flow.md) for the complete sequence:

1. **cert-manager** (Helm)
2. **Vault** (Helm + init + unseal + PKI setup)
3. **Monitoring Stack** (Kustomize)
4. **Keycloak, Harbor, Mattermost, Kasm** (parallel)
5. **ArgoCD + Argo Rollouts** (Helm + app-of-apps bootstrap)

Each service has its own README in `services/<name>/README.md` with step-by-step deployment instructions.

---

## Deploying Workloads

### Gateway API with Traefik

When creating a Gateway with the `traefik` GatewayClass, listener ports must match Traefik's **entrypoint ports** (not the service ports):

- HTTP: use port `8000` (maps to service port 80)
- HTTPS: use port `8443` (maps to service port 443)

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: my-gateway
spec:
  gatewayClassName: traefik
  listeners:
  - name: http
    protocol: HTTP
    port: 8000              # Traefik entrypoint port, NOT 80
```

### Gateway API with Cilium

For the `cilium` GatewayClass, use standard ports (80, 443). Cilium provisions its own LoadBalancer service per Gateway.

### IngressRoute (exceptions only)

IngressRoute is only used for services requiring Traefik-specific features with no Gateway API equivalent:
- **Traefik Dashboard**: Routes to `api@internal` (TraefikService, not a K8s Service)
- **Kasm**: Backend HTTPS with `serversTransport` insecureSkipVerify

All other services use Gateway API. Basic-auth is supported via `extensionRef` filter in HTTPRoute pointing to existing Traefik Middleware CRDs. See [docs/decision-tree.md](docs/decision-tree.md) for routing method selection.

---

## Secret Management

The `cluster/terraform.sh` wrapper manages sensitive files as Kubernetes secrets on the Harvester cluster:

| Local File | K8s Secret Name | Contains |
|-----------|----------------|---------|
| `cluster/terraform.tfvars` | `terraform-tfvars` | All variable values including tokens |
| `cluster/kubeconfig-harvester.yaml` | `kubeconfig-harvester` | Harvester cluster access |
| `cluster/harvester-cloud-provider-kubeconfig` | `harvester-cloud-provider-kubeconfig` | Cloud provider service account |
| `cluster/vault-init.json` | `vault-init` | Vault root token + unseal keys |

Commands (run from `cluster/`):
- `./terraform.sh push-secrets` -- upload local files to K8s secrets
- `./terraform.sh pull-secrets` -- download K8s secrets to local files

All files are `.gitignore`'d.

### Credentials output

After deployment, `deploy-cluster.sh` writes `cluster/credentials.txt` with all service URLs and passwords. This file is `.gitignore`'d and `chmod 600`. Store it securely.

---

## Further Reading

| Topic | Document |
|-------|----------|
| Platform overview | [README.md](README.md) |
| Architecture & node pools | [docs/architecture.md](docs/architecture.md) |
| All services & dependencies | [docs/service-architecture.md](docs/service-architecture.md) |
| Networking & ingress | [docs/network-flow.md](docs/network-flow.md) |
| Deployment sequence | [docs/deployment-flow.md](docs/deployment-flow.md) |
| Routing & pool decisions | [docs/decision-tree.md](docs/decision-tree.md) |
| Security & TLS | [docs/security.md](docs/security.md) |
| Known issues & fixes | [docs/troubleshooting.md](docs/troubleshooting.md) |
| Day-2 operations | [docs/operations-runbook.md](docs/operations-runbook.md) |
