# Developer's Guide

Quick-start guide for setting up and operating the RKE2 cluster. For detailed architecture and operations, see the linked docs.

## Table of Contents

- [File Structure](#file-structure)
- [Prerequisites](#prerequisites)
- [Deployment](#deployment)
- [Deploying Workloads](#deploying-workloads)
- [Secret Management](#secret-management)
- [Further Reading](#further-reading)

---

## File Structure

```
.
├── README.md                 # Platform overview and documentation index
├── DEVELOPERS_GUIDE.md       # This file
├── cluster/                  # Terraform infrastructure
│   ├── versions.tf           # Terraform/provider version constraints, K8s backend
│   ├── providers.tf          # Rancher2 + Harvester provider config
│   ├── variables.tf          # All input variables with defaults
│   ├── terraform.tfvars.example  # Example variable values
│   ├── cloud_credential.tf   # Data source for existing Harvester cloud credential
│   ├── image.tf              # Rocky 9 image upload to Harvester
│   ├── machine_config.tf     # Machine configs + cloud-init (CP vs worker split)
│   ├── cluster.tf            # RKE2 cluster resource (pools, chart values, CNI config)
│   ├── outputs.tf            # Cluster ID, image ID, credential ID
│   └── terraform.sh          # Wrapper script (secret management + terraform commands)
├── services/                 # Kubernetes workloads
│   ├── monitoring-stack/     # Prometheus, Grafana, Loki, Alloy, Alertmanager
│   ├── vault/                # Vault HA (3-replica Raft)
│   ├── cert-manager/         # ClusterIssuer, RBAC
│   ├── keycloak/             # Keycloak HA IDP
│   ├── argo/                 # ArgoCD + Argo Rollouts
│   ├── harbor/               # Harbor HA container registry
│   ├── mattermost/           # Mattermost team messaging
│   ├── kasm/                 # Kasm virtual desktops
│   ├── rbac/                 # Kubernetes RBAC (ClusterRoles, bindings)
│   ├── node-labeler/         # Custom operator: auto-labels nodes by pool
│   ├── storage-autoscaler/   # Custom operator: PVC auto-expansion
│   ├── uptime-kuma/          # Status monitoring (optional)
│   ├── librenms/             # Network monitoring (optional)
│   └── gitlab/               # GitLab (optional, Phase 11)
└── docs/                    # Architecture and engineering references
    ├── README.md            # Master documentation index
    ├── engineering/          # 10 comprehensive engineering references
    │   ├── system-architecture.md
    │   ├── terraform-infrastructure.md
    │   ├── deployment-automation.md
    │   ├── services-reference.md
    │   ├── monitoring-observability.md
    │   ├── security-architecture.md
    │   ├── custom-operators.md
    │   ├── golden-image-cicd.md
    │   ├── flow-charts.md
    │   └── troubleshooting-sop.md
    ├── kubectl-oidc-setup.md # End-user OIDC auth guide
    ├── vault-ha.md          # Vault HA migration (implemented)
    ├── vault-credential-storage.md # Vault KV + ESO plan
    └── golden-image-plan.md # Golden image design record
```

---

## Prerequisites

1. **Rancher server** with Harvester virtualization management enabled
2. **Rancher API key** (global scope) -- Rancher UI > User Avatar > Account & API Keys
3. **Harvester context in `~/.kube/config`** -- The deploy script auto-extracts `cluster/kubeconfig-harvester.yaml` from this context. Default context name is `harvester` (configurable via `HARVESTER_CONTEXT` in `scripts/.env`)
4. **Harvester cloud credential** created in Rancher (Rancher UI > Cluster Management > Cloud Credentials)
5. **Tools:** `terraform >= 1.5.0`, `kubectl`, `jq`, `helm`, `openssl`, `curl`

> **Note:** Both `cluster/kubeconfig-harvester.yaml` and `cluster/harvester-cloud-provider-kubeconfig` are auto-generated by `deploy-cluster.sh` if missing. The cloud provider kubeconfig is generated via the Rancher API using values from `terraform.tfvars`.

<details>
<summary>Manual Reference: Cloud provider kubeconfig generation</summary>

If you need to generate the cloud provider kubeconfig manually (e.g., without `deploy-cluster.sh`):

```bash
curl -sk -X POST \
  "https://<RANCHER_URL>/k8s/clusters/<HARVESTER_MGMT_CLUSTER_ID>/v1/harvester/kubeconfig" \
  -H 'Content-Type: application/json' \
  -u '<ACCESS_KEY>:<SECRET_KEY>' \
  -d '{"clusterRoleName":"harvesterhci.io:cloudprovider",
       "namespace":"<VM_NAMESPACE>",
       "serviceAccountName":"<CLUSTER_NAME>"}' \
  > cluster/harvester-cloud-provider-kubeconfig
```

</details>

---

## Deployment

### First-time setup

```bash
cd cluster
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your actual values

./terraform.sh init       # Creates K8s namespace, pushes secrets, initializes backend
./terraform.sh plan       # Preview changes
./terraform.sh apply      # Deploy (takes ~20-30 minutes)
```

### Day-2 operations

```bash
cd cluster
./terraform.sh plan       # Always preview first
./terraform.sh apply      # Apply changes (in-place when possible, rolling replace for node changes)
./terraform.sh destroy    # Tear down entire cluster
```

> **Important:** `terraform.sh` runs `pull_secrets` before every terraform command, which overwrites your local `terraform.tfvars`. Always run `./terraform.sh push-secrets` after editing `terraform.tfvars` locally. All commands are run from the `cluster/` directory.

### State management

Terraform state is stored in a Kubernetes secret on the Harvester cluster (`terraform-state` namespace, secret `tfstate-default-rke2-cluster`). The `cluster/terraform.sh` wrapper manages syncing sensitive files (tfvars, kubeconfigs, vault-init.json) as K8s secrets.

### Service deployment

After the cluster is ready, deploy services in 12 phases (0-11). See [docs/engineering/deployment-automation.md](docs/engineering/deployment-automation.md) for the complete sequence.

The recommended approach is to use the automated zero-touch deployment script:

```bash
./scripts/deploy-cluster.sh              # Full 12-phase deployment
./scripts/deploy-cluster.sh --from 3     # Resume from phase 3
./scripts/deploy-cluster.sh --skip-tf    # Skip Terraform (phase 0)
```

**Phase overview:** 0: Terraform, 1: Foundation (cert-manager, CNPG, Redis Operator, Node Labeler, Cluster Autoscaler), 2: Vault + PKI, 3: Monitoring, 4: Harbor, 5: ArgoCD + Rollouts, 6: Keycloak, 7: Remaining Services (Mattermost, Kasm, Uptime Kuma, LibreNMS), 8: DNS Records, 9: Validation + RBAC, 10: Keycloak OIDC + oauth2-proxy ForwardAuth, 11: GitLab.

Each service has its own README in `services/<name>/README.md` with step-by-step deployment instructions.

---

## Deploying Workloads

### Gateway API with Traefik

When creating a Gateway with the `traefik` GatewayClass, listener ports must match Traefik's **entrypoint ports** (not the service ports):

- HTTP: use port `8000` (maps to service port 80)
- HTTPS: use port `8443` (maps to service port 443)

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: my-gateway
spec:
  gatewayClassName: traefik
  listeners:
  - name: http
    protocol: HTTP
    port: 8000              # Traefik entrypoint port, NOT 80
```

### Gateway API with Cilium

For the `cilium` GatewayClass, use standard ports (80, 443). Cilium provisions its own LoadBalancer service per Gateway.

### IngressRoute (exceptions only)

IngressRoute is only used for services requiring Traefik-specific features with no Gateway API equivalent:
- **Traefik Dashboard**: Routes to `api@internal` (TraefikService, not a K8s Service)
- **Kasm**: Backend HTTPS with `serversTransport` insecureSkipVerify

All other services use Gateway API. oauth2-proxy ForwardAuth is used for services without native login (Prometheus, Alertmanager, Hubble, Traefik Dashboard, Rollouts). See [docs/engineering/flow-charts.md](docs/engineering/flow-charts.md) for routing method selection.

---

## Secret Management

The `cluster/terraform.sh` wrapper manages sensitive files as Kubernetes secrets on the Harvester cluster:

| Local File | K8s Secret Name | Contains |
|-----------|----------------|---------|
| `cluster/terraform.tfvars` | `terraform-tfvars` | All variable values including tokens |
| `cluster/kubeconfig-harvester.yaml` | `kubeconfig-harvester` | Harvester cluster access |
| `cluster/harvester-cloud-provider-kubeconfig` | `harvester-cloud-provider-kubeconfig` | Cloud provider service account |
| `cluster/vault-init.json` | `vault-init` | Vault root token + unseal keys |

Commands (run from `cluster/`):
- `./terraform.sh push-secrets` -- upload local files to K8s secrets
- `./terraform.sh pull-secrets` -- download K8s secrets to local files

All files are `.gitignore`'d.

### Credentials output

After deployment, `deploy-cluster.sh` writes `cluster/credentials.txt` with all service URLs and passwords. This file is `.gitignore`'d and `chmod 600`. Store it securely.

---

## Further Reading

| Topic | Document |
|-------|----------|
| Platform overview | [README.md](README.md) |
| Architecture & node pools | [docs/engineering/system-architecture.md](docs/engineering/system-architecture.md) |
| All services & dependencies | [docs/engineering/services-reference.md](docs/engineering/services-reference.md) |
| Networking & ingress | [docs/engineering/system-architecture.md](docs/engineering/system-architecture.md) |
| Deployment sequence | [docs/engineering/deployment-automation.md](docs/engineering/deployment-automation.md) |
| Routing & pool decisions | [docs/engineering/flow-charts.md](docs/engineering/flow-charts.md) |
| Security & TLS | [docs/engineering/security-architecture.md](docs/engineering/security-architecture.md) |
| Known issues & fixes | [docs/engineering/troubleshooting-sop.md](docs/engineering/troubleshooting-sop.md) |
| Day-2 operations | [docs/engineering/troubleshooting-sop.md](docs/engineering/troubleshooting-sop.md) |
